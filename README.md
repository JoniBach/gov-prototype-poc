# Playwright Gen POC
A proof of concept for AI enhanced left shift test automation by @jonibach

```
Engineering is a definative art

AI is devoid of art and exclusively uncertain

Therefore to control AI

Is to apply the art of engineering 

To strucutre uncertainty
```

## Brief intro
This POC investigates one particular way of working with AI. Although its currently one cohesive monolith, conceptually, you could consider it as being the sum of three parts.

1. **Dynamic UI Prototype** - Frameworked in *SvelteKit*
2. **Dynamic Component Test Sequencer** - Powered by *Playwright*
3. **Generative AI scripts** - leveraging *zod* schema'd structured output & *OpenAI*

## Quick Start Guide
### Setup
Ensure you have node, VSCode and the compatable Playwright plugin installed locally on your machine

1. Clone the project
2. Enter the project root directory
3. Create a .env file with the following
```
# OpenAI API Configuration
OPENAI_API_KEY=sk-proj-xxx

# Optional: Specify OpenAI model (defaults to gpt-4o-2024-08-06)
OPENAI_MODEL=gpt-5.1

# Optional: OpenAI organization (if you have multiple orgs)
OPENAI_ORG_ID=org-xxx
```
4. Install the node modules

``` 
npm install
```

5. Run the UI
```
npm run dev
```
*You can now visit http://localhost:5173/ and see the journeys*

6. Start the AI CLI script
```
npm run gen
```
7. Enter the name of a journey you would like to generate
```
Apply for a passport
```
```
Simple self assessment
```
```
Renew drivers license 
```
8. Visit http://localhost:5173/journey and review your new journey
9. Run test suite in UI mode
```
npx playwright test --ui e2e/journeys/Journeys.test.ts
```
10. Create a user flow test
- Open the testing tool in VSCode
- Navigate to The playwright acordion 
- Navigate to the Tools Subsection
- Click Record New
- When the automated browser window opens, enter the URL of your journey
- Carry out the user flow you want to test
- Stop the recording
- Return the VSCode and you should see a recorded test file 
- Move it to the /recordings directory
- In your terminal run the following
```
npx playwright test e2e/journeys/UserFlows.test.ts
```

### What just happened
1. You just executed a script to generate static json files that match a journey
2. SvelteKit had iterated over each step of the journey as a dynamic component in the UI based on the JSON array that was generated
3. Playwright has just iterated over each step of the journey and run the requisite component tests in order to validate it worked
4. You just recorded a user flow in the browser and generated a Playwright test


## How the code works
### 1 - The AI (Zod & OpenAI)
In `static/journeys` you will find json files that were generated by AI strucutred output based on a prompt

The `index.json` contains information that will be used to generate the user journeys. It is also used as the source of truth for the app's router

The `your-journey-here.json` is a file that contains the information for all of the pages and components. This will be used to render the frontend and generate the tests.

The `src/lib/ai/main.ts` file is the entry point for the AI CLI. 

The `prototypeSteps` function in `src/lib/ai/gen.ts` contains a custom built tooling chain to process the end to end journey generation. The flow looks something like this 

The `src/lib/ai/prompts.ts` contains `zod` schemas that are serialised into strucutred output. They will be the basis for the prompts to control the format of the AI outputs.
```
Ask user for a prompt
|
V
Generate journey index and blueprint with promt
|
V
Generate high-level journey structure
|
V
Generate detailed component configurations
|
V
Display generation summary
```

### 2 - The UI (Svelte)

In `src/lib/components/gds` you will find a "generally" complete(ish) set of Gov Design System components.

In `src/routes/journey` you will find self routing pages that correlate to the url paths (this is how sveltekit handles its router). 

Each page is created by iterating over the selected journey array and each compoent is created by iterating over the internal array of compoennts inside that page.

### 3 - The Tests
In `e2e/components` you will find a fairly (but not significantly) complete set of compoennt tests that relate to each component in the GDS. Each is completely donfigurable with different parameters.

in `e2e/journeys/Journeys.test.ts` you will see a similar pattern as found in the sveltekit ui. Each page and compoennt in the UI is iterated over using the identical configuration as is in the UI. These tests just repurpose the component tests to validate the UI is fully usable.

In `/recordings` you will find your recorded user flows. This is where you will test the different scenarios that you expect to see in the app. Any changes made to the journey (should) always pass in the journey tests. However your flows will fail - thus indicating potential regression / areas where you will find change downstream. 

``` 
Note from the author @jonibach
This means that the journey tests are ENTIRELY self healing by nature.
The flow tests are compeltely manual.
Theres no reason they cant both be self healing with some clever thinking...
It's that this investigation needs to end somewhere. 
```